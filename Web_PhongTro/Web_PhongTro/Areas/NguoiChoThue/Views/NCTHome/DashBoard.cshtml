@model IEnumerable<Web_PhongTro.ViewModels.BaiDangVM>

@{ ViewBag.Title = "DashBoard";
    Layout = "~/Areas/NguoiChoThue/Views/Shared/_Layout.cshtml"; }



<div id="frmThemBaiDang" class="frm-post">
    <div class="close-btn">×</div>

    <div class="ad-info">
        <form asp-action="SaveDiaChi" asp-controller="DangBai" method="post">
            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-12">
                        <h1>Địa chỉ cho thuê</h1>
                    </div>
                </div>
                @Html.Action("DanhSachDiaChi", "DangBai")
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="street_number" class="col-form-label">Số nhà</label>
                        <input type="text" class="form-control js-input-street-number" name="street_number" id="street_number" value="">
                    </div>
                </div>
            </div>
            <div class="form-group row mt-5">
                <div class="col-md-12">
                    <h3>Thông tin mô tả</h3>
                </div>
            </div>
            @Html.Action("GetDanhSachDanhMuc", "DangBai")

            @Html.Action("GetDanhSachPhongTro", "DangBai")
            <div class="form-group row">
                <label for="post_title" class="col-md-12 col-form-label">Tiêu đề</label>
                <div class="col-md-12">
                    <input type="text" class="form-control js-title" name="tieu_de" id="post_title" value="" minlength="30" maxlength="120" required="" data-msg-required="Tiêu đề không được để trống" data-msg-minlength="Tiêu đề quá ngắn" data-msg-maxlength="Tiêu đề quá dài">
                </div>
            </div>
            <div class="form-group row">
                <label for="post_content" class="col-md-12 col-form-label">Nội dung mô tả</label>
                <div class="col-md-12">
                    <textarea class="form-control js-content" name="noi_dung" id="post_content" rows="10" required="" minlength="100" data-msg-required="Bạn chưa nhập nội dung" data-msg-minlength="Nội dung tối thiểu 100 kí tự"></textarea>
                </div>
            </div>
            @*  @Html.Action("ThongTinLienHe", "DangBai")*@
            <div class="form-group row">
                @*<label for="phone" class="col-md-12 col-form-label">Thông tin liên hệ</label>
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <input id="ten_lien_he" type="text" name="ten_lien_he" class="form-control" readonly="readonly"  required="" value="@ViewBag.TenLienHe" data-msg-required="Tên liên hệ">

                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="phone" class="col-md-12 col-form-label">Điện thoại</label>
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <input id="phone" type="number" name="phone" class="form-control" readonly="readonly" required="" value="@ViewBag.SoDienThoai" data-msg-required="Số điện thoại">
                            </div>
                        </div>
                    </div>*@
                <div class="form-group row">
                    <label for="giachothue" class="col-md-12 col-form-label">Giá cho thuê</label>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input id="giachothue" name="gia" pattern="[0-9.]+" type="text" class="form-control js-gia-cho-thue" required="" data-msg-required="Bạn chưa nhập giá phòng" data-msg-min="Giá phòng chưa đúng">
                            <div class="input-group-append">
                                <span class="input-group-text">đồng/tháng</span>
                            </div>
                        </div>
                    </div>
                    <label for="text_giachothue" id="text_giachothue" class="col-sm-12 control-label js-number-text" style="color: red;"></label>
                </div>
                <div class="form-group row">
                    <label for="post_acreage" class="col-md-12 col-form-label">Diện tích</label>
                    <div class="col-md-6">
                        <div class="input-group mb-3">
                            <input id="post_acreage" type="number" attern="[0-9.]+" name="dien_tich" max="1000" class="form-control valid" required="" data-msg-required="Bạn chưa nhập diện tích" aria-invalid="false">
                            <div class="input-group-append">
                                <span class="input-group-text">m<sup>2</sup></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group row mt-5">
                    <div class="col-md-12">
                        <h3>Hình ảnh</h3>
                    </div>
                </div>
                <div class="image-upload-container">
                    <div class="image-upload-box">
                        <label for="image-upload" class="image-upload-label">
                            <i class="fas fa-plus"></i>
                            <i class="bi bi-images"></i>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5" />
                                <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z" />
                            </svg>
                            <span>Thêm ảnh</span>
                        </label>
                        <input type="file" id="image-upload" class="image-upload-input" accept="image/*" multiple>
                    </div>
                    <div class="uploaded-images">
                        <!-- Các hình ảnh được tải lên sẽ được hiển thị ở đây -->
                    </div>
                    <script>
                        const uploadInput = document.getElementById('image-upload');
                        const uploadedImagesContainer = document.querySelector('.uploaded-images');

                        uploadInput.addEventListener('change', function () {
                            const files = Array.from(uploadInput.files);

                            files.forEach(file => {
                                const reader = new FileReader();

                                reader.onload = function (e) {
                                    const img = document.createElement('img');
                                    img.src = e.target.result;
                                    img.classList.add('uploaded-image');

                                    const deleteButton = document.createElement('button');
                                    deleteButton.innerHTML = 'Xóa';
                                    deleteButton.classList.add('delete-button');
                                    deleteButton.addEventListener('click', function () {
                                        uploadedImagesContainer.removeChild(imageContainer);
                                    });

                                    const imageContainer = document.createElement('div');
                                    imageContainer.classList.add('image-container');
                                    imageContainer.appendChild(img);
                                    imageContainer.appendChild(deleteButton);

                                    uploadedImagesContainer.appendChild(imageContainer);
                                };

                                reader.readAsDataURL(file);
                            });
                        });
                    </script>
                </div>
                <div class="form-group row mt-5">
                    <div class="col-md-12">
                        @*<button type="button" class="btn btn-primary mt-3" onclick="saveDiaChi()">Tiếp tục</button>*@
                        <button type="button" class="btn btn-primary mt-3" id="btn-tieptuc">Tiếp tục</button>
                    </div>
                    <script>
                        $(document).ready(function () {
                            $('#btn-tieptuc').click(function () {
                                // Lấy dữ liệu từ form
                                var baiDangData = {
                                    IdNguoiChoThue: $('#nguoiChoThue').val(),
                                    ThanhPho: $('#province_id').val(),
                                    Quan: $('#district_id').val(),
                                    Phuong: $('#phuongxa').val(),
                                    Duong: $('#street_number').val(),
                                    LoaiChuyenMuc: $('#post_cat').val(),
                                    TieuDe: $('#post_title').val(),
                                    NoiDung: $('#post_content').val(),
                                    DienTich: $('#post_acreage').val(),
                                    Gia: $('#giachothue').val(),
                                };

                                // Gửi Ajax request để lưu bài đăng
                                $.ajax({
                                    url: '/DangBai/ThemBai', // Đường dẫn đến action ThemBai trong controller
                                    type: 'POST',
                                    data: baiDangData,
                                    success: function (response) {
                                        if (response.success) {
                                            alert(response.message);
                                            // Làm mới trang hoặc chuyển hướng nếu cần
                                            location.reload();
                                        } else {
                                            alert(response.message);
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.log('Lỗi:', error);
                                        alert('Đã xảy ra lỗi khi thêm bài đăng.');
                                    }
                                });
                            });
                        });

                    </script>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="activity" id="posts">
    <div class="title">
        <i class="uil uil-package"></i>
        <span class="text">Danh sách bài đăng</span>
    </div>
    <div class="activity-data">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <td colspan="8">
                        @using (Html.BeginForm("GetAll", "NCTHome", FormMethod.Post, new { id = "post-search-form" }))
                        {
            <select class="form-select" name="postsearchType" id="post-search-type" required>
                <option value="name">Tìm theo tên</option>
            </select>
                            <input class="form-control" type="text" placeholder="Tìm kiếm..." name="postsearchInput" id="post-search-input" required>
                                            <button type="submit" class="btn btn-light" id="btn-search-post">
                                                <i class="fa fa-search" style="color: #3557ff;"></i>
                                                Tìm kiếm
                                            </button>}
                        <button class="btn btn-light" id="btn-add-post">
                            <i class="fa fa-plus-square" style="color: #3557ff;"></i>
                            Thêm bài đăng mới
                        </button>
                    </td>

                </tr>
            </thead>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Tiêu đề</th>

                    <th>
                        Địa chỉ
                        <div>
                            @*<a href="@Url.Action("GetAll","posts", new { sortCol = "GiaGoc",sortType = "DESC", page = ViewBag.Page})" class="fa fa-solid fa-sort-up"></a>*@
                            @*<a href="@Url.Action("GetAll","posts", new { sortCol = "GiaGoc",sortType = "ASC", page = ViewBag.Page})" class="fa fa-solid fa-sort-down"></a>*@
                        </div>
                    </th>
                    <!--<th>
                            Giảm giá
                            <div>-->
                    @*<a href="@Url.Action("GetAll","posts", new { sortCol = "GiamGia",sortType = "DESC", page = ViewBag.Page})" class="fa fa-solid fa-sort-up"></a>*@
                    @*<a href="@Url.Action("GetAll","posts", new { sortCol = "GiamGia",sortType = "ASC", page = ViewBag.Page})" class="fa fa-solid fa-sort-down"></a>*@
                    <!--</div>
                    </th>-->
                    <th>
                        Số Lượng yêu thích
                        <div>
                            @*<a href="@Url.Action("GetAll","NCTHome", new { sortCol = "SoLuongDanhGia",sortType = "DESC", page = ViewBag.Page})" class="fa fa-solid fa-sort-up"></a>*@
                            @*<a href="@Url.Action("GetAll","NCTHome", new { sortCol = "SoLuongDanhGia",sortType = "ASC", page = ViewBag.Page})" class="fa fa-solid fa-sort-down"></a>*@
                        </div>
                    </th>
                    <th>
                        Trạng thái
                        @*<div>
                                <a href="@Url.Action("GetAll","posts", new { sortCol = "GiaDaGiam",sortType = "DESC", page = ViewBag.Page})" class="fa fa-solid fa-sort-up"></a>
                                <a href="@Url.Action("GetAll","posts", new { sortCol = "GiaDaGiam",sortType = "ASC", page = ViewBag.Page})" class="fa fa-solid fa-sort-down"></a>
                            </div>*@
                    </th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="post-table-body">
                @{ int stt = ViewBag.STT;}
                @foreach (var item in Model)
                {

    <tr>
        <td>@(stt++)</td>
        <td>
            <a href="@Url.Action("GetBaiDangById", "BaiDang", new { area = "", id = item.BaiDang.IdBaiDang })" target="_blank">@item.BaiDang.TieuDe</a>
            <img src="~/Content/Images/@item.BaiDang.AnhBaiDang" alt="">
        </td>
        @*<td>@string.Format("{0:N0}", item.Gia) đ</td>*@
        <td>@item.diachiPT.Phuong @item.diachiPT.Quan</td>
        <td>@item.BaiDang.SoLuongYeuThich</td>
        <td>@item.BaiDang.TrangThai</td>

        <td>
            <button type="button" class="edit-post-btn" data-post-id="@item.BaiDang.IdBaiDang"><i class="fa fa-wrench"></i></button>
            <button type="button" class="delete-post-btn" data-post-id="@item.BaiDang.IdBaiDang"><i class="fa fa-trash"></i></button>
        </td>
    </tr>
}
            </tbody>
        </table>
    </div>
    @if (ViewBag.NoOfPages > 1)
    {
<div class="break-page">
    @{ int PrevPage = ViewBag.Page - 1;
        if (PrevPage <= 0)
        {
            PrevPage = 1;
        }
        int NextPage = ViewBag.Page + 1;
        if (NextPage >= ViewBag.NoOfPages)
        {
            NextPage = ViewBag.NoOfPages;
        } }
    <div><a class="buttons prev-button" href="@Url.Action("GetAll","NCTHome")/?page=@PrevPage">&lt;&lt;</a></div>
    @for (int i = 0; i < ViewBag.NoOfPages; i++)
    {
        if (i + 1 == ViewBag.Page)
        {
<div>
    <a href="@Url.Action("GetAll","NCTHome")/?page=@(i+1)" class="buttons active">@(i+1)</a>
</div> }
else
{
<div>
    <a href="@Url.Action("GetAll","NCTHome")/?page=@(i+1)" class="buttons">@(i+1)</a>
</div>}

}
    <div><a class="buttons next-button" href="@Url.Action("GetAll","NCTHome")/?page=@NextPage">&gt;&gt;</a></div>
</div>}
</div>
@section scriptsFooter {
    <script src="~/Areas/NguoiChoThue/Content/Script/ScriptPost.js"></script>
}
<script>
    let btnAddpost = document.querySelector('#btn-add-post');
    let frmPost = document.querySelector('.frm-post');
    let closeBtn = document.querySelector('.frm-post .close-btn');

    btnAddpost.addEventListener('click', function () {
        frmPost.classList.add('active');
    });

    closeBtn.addEventListener('click', function () {
        frmPost.classList.remove('active');
    });



       $(document).ready(function () {
            $('#district_id').prop('disabled', true);
            $('#phuongxa').prop('disabled', true);

            // When a province is selected
            $('#province_id').change(function () {
                var selectedProvince = $(this).val();

                if (selectedProvince !== "") {
                    $('#district_id').prop('disabled', false);

                    // TODO: Make an AJAX call to load districts for the selected province
                    // Example:
                    // $.ajax({
                } else {
                    $('#district_id').prop('disabled', true).val('');
                    $('#phuongxa').prop('disabled', true).val('');
                }

                // Disable the ward dropdown since no district is selected yet
                $('#phuongxa').prop('disabled', true);
            });

            // When a district is selected
            $('#district_id').change(function () {
                var selectedDistrict = $(this).val();

                if (selectedDistrict !== "") {
                    // Enable the ward dropdown
                    $('#phuongxa').prop('disabled', false);
                    $.ajax({
                        url: '@Url.Action("GetWardsByDistrict", "DangBai")',
                        type: 'GET',
                        data: { district: selectedDistrict },
                        success: function (data) {
                            $('#phuongxa').prop('disabled', false);
                            $('#phuongxa').html(''); // Clear current options
                            $('#phuongxa').append('<option value="">-- Chọn Phường/Xã --</option>'); // Default option

                            // Populate ward dropdown with the new data
                            $.each(data, function (index, ward) {
                                $('#phuongxa').append('<option value="' + ward + '">' + ward + '</option>');
                            });
                        }
                    });


                } else {
                    // If no district is selected, disable the ward dropdown
                    $('#phuongxa').prop('disabled', true).val('');
                }
            });
        });

</script>
@section PartialView{
    @Html.Action("EditPartial", "NCTHome")
}